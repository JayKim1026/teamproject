<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.delivery.report">

	<insert id="report">
		insert into tbl_report(report_no, plt_no, def_no, report_code, report_type)
		values(seq_report_no.nextval, #{plt_no}, #{def_no}, #{report_content}, #{report_type})
	</insert>
	
	<select id="getReportList" resultType="ReportVo">
		select r.*, p.plt_name, d.def_name, c.code_detail report_detail, c1.code_detail state_detail, c2.code_detail type_detail, a.admin_name 
		from tbl_report r
		inner join (
		    select user_no plt_no, user_name plt_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) p
		on r.plt_no = p.plt_no
		inner join (
		    select user_no def_no, user_name def_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) d
		on r.def_no = d.def_no
		inner join tbl_code c
		on r.report_code = c.code_no
		inner join tbl_code c1
		on r.report_state = c1.code_no
		inner join tbl_code c2
		on r.report_type = c2.code_no
		left outer join tbl_admin a
		on r.admin_no = a.admin_no
		where report_state = '6-001'
		<if test='report_type != ""'>
			and report_type = #{report_type}
		</if>
	</select>
	
	<update id="approveReport">
		update tbl_report set
			report_state = '6-002', 
			admin_no = #{admin_no}
		where report_no = #{report_no}
	</update>
	
	<update id="revokeReport">
		update tbl_report set
			report_state = '6-003', 
			admin_no = #{admin_no}
		where report_no = #{report_no}
	</update>
	
</mapper>
