<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.delivery.admin">
	<!-- Login -->
	<select id="login" resultType="AdminVo">
		select * from tbl_admin
		where admin_id = #{admin_id}
		and admin_pw = #{admin_pw}
	</select>
	<!-- Login 끝 -->
	
	<!-- 회원 관련 카운트 -->
	<select id="getNewMemberCount" resultType="int">
		select count(*) from tbl_user
		where user_date &gt;= (
			select to_char(sysdate -1, 'YYYY-MM-DD')
	    	from dual) 
		and user_date &lt;= sysdate
	</select>
	
	<select id="getWaitingDeliveryCount" resultType="int">
		select count(*) from tbl_deliver
		where dlvr_state = '1-001'
		and dlvr_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and dlvr_date &lt;= sysdate
	</select>
	
	<select id="getNewDeliveryCount" resultType="int">
		select count(*) from tbl_deliver
		where dlvr_state = '1-002'
		and dlvr_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and dlvr_date &lt;= sysdate
	</select>
	
	<select id="getTotalMemberCount" resultType="int">
		select count(*) from tbl_user
	</select>
	
	<select id="getTotalDeliveryCount" resultType="int">
		select count(*) from tbl_deliver
	</select>
	<!-- 회원 관련 카운트 끝-->
	
	<!-- 주문관련 카운트 -->
	<select id="getRequestedOrderCount" resultType="int">
		select count(*) from tbl_order
		where order_state = '3-001'
		and order_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and order_date &lt;= sysdate
	</select>
	
	<select id="getOrderInProgressCount" resultType="int">
		select count(*) from tbl_order
		where order_state = '3-002'
		and order_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and order_date &lt;= sysdate
	</select>
	
	<select id="getFinishedOrderCount" resultType="int">
		select count(*) from tbl_order
		where order_state = '3-003'
		and order_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and order_date &lt;= sysdate
	</select>

	<select id="getTotalFinishedOrderCount" resultType="int">
		select count(*) from tbl_order
		where order_state = '3-003'
	</select>

	<select id="getTotalCanceledOrderCount" resultType="int">
		select count(*) from tbl_order
		where order_state = '3-004'
	</select>
	
	<select id="getTotalCanceledDeliverCount" resultType="int">
		select count(*) from tbl_order
		where order_state = '3-005'
	</select>
	<!-- 주문관련 카운트 끝-->
	
	<!-- 게시물 관련 카운트 -->
	<select id="getNewPostCount" resultType="int">
		select count(*) from tbl_timeline
		where time_state = '2-003'
		and time_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and time_date &lt;= sysdate
	</select>
	
	<select id="getNewReviewCount" resultType="int">
		select count(*) from tbl_timeline
		where time_state = '2-002'
		and time_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and time_date &lt;= sysdate
	</select>
	
	<select id="getNewNoticeCount" resultType="int">
		select count(*) from tbl_timeline
		where time_state = '2-001'
		and time_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and time_date &lt;= sysdate
	</select>
	
	<select id="getTotalPostCount" resultType="int">
		select count(*) from tbl_timeline
		where time_state = '2-003'
	</select>	
	
	<select id="getTotalReviewCount" resultType="int">
		select count(*) from tbl_timeline
		where time_state = '2-002'
	</select>
	<!-- 게시물 관련 카운트 끝-->
	
	<!-- 신고 관련 카운트 -->
	
	<select id="getNewRequestedReportCount" resultType="int">
		select count(*) from tbl_report
		where report_state = '6-001'
		and report_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and report_date &lt;= sysdate
	</select>
	
	<select id="getNewPostReportCount" resultType="int">
		select count(*) from tbl_report
		where report_type = '6-012'
		and report_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and report_date &lt;= sysdate
	</select>
	
	<select id="getNewCommentReportCount" resultType="int">
		select count(*) from tbl_report
		where report_type = '6-013'
		and report_date &gt;= (
		select to_char(sysdate -1, 'YYYY-MM-DD')
	    from dual) 
		and report_date &lt;= sysdate
	</select>
	
	<select id="getTotalPostReportCount" resultType="int">
		select count(*) from tbl_report
		where report_type = '6-012'
	</select>
	
	<select id="getTotalCommentReportCount" resultType="int">
		select count(*) from tbl_report
		where report_type = '6-013'
	</select>
	
	<select id="getFinishedReportCount" resultType="int">
		select count(*) from tbl_report
		where report_state = '6-002'	
	</select>
	<!-- 신고 관련 카운트 끝-->
	
	<!-- 회원 리스트 가지고오기 -->
	<!-- 일반회원 리스트 -->
	<select id="getMemberList" resultType="UserVo">
		select * from tbl_user
	</select>
	
	<!-- 배달원 리스트 -->
	<select id="getDeliverList" resultType="DeliverVo">
		select * from tbl_deliver
	</select>
	
	<!-- 	가입 대기중 배달원 리스트 -->
	<select id="getWaitingDeliverList" resultType="DeliverVo" >
		select * from tbl_deliver
		where dlvr_state = '1-001'
	</select>
	<!-- 회원 리스트 가지고오기 끝-->
	
	<!-- 계정 상태 수정-->
	<update id="userStateUpdate">
		update tbl_user set
		user_state = #{user_state}
		where user_no = #{user_no}
	</update>

	<update id="deliverStateUpdate">
		update tbl_deliver set
		dlvr_state = #{dlvr_state}
		where dlvr_no = #{dlvr_no}
	</update>
	<!-- 계정 상태 수정 -->
	
	<!-- 주문(현황:대기중, 접수, 사용자취소, 배달원취소, 완료)목록 + 현황수정 -->
	<!-- 대기중인 주문 목록 -->
	<select id="getWaitingOrderList" resultType="OrderVo">
		select o.*, u.user_name from tbl_order o
		inner join tbl_user u
		on o.user_no = u.user_no     
		inner join tbl_code c
		on o.order_state = c.code_no
		where o.order_state = '3-001'
		order by o.order_date desc
	</select>
	
	<!-- 접수된 주문 목록 -->
	<select id="getAcceptOrderList" resultType="OrderVo">
		select o.*, u.user_name, d.dlvr_name 
        from tbl_order o
        inner join tbl_user u
        on o.user_no = u.user_no
        left outer join tbl_deliver d
        on o.dlvr_no = d.dlvr_no
        inner join tbl_code c
        on o.order_state = c.code_no
        where o.order_state = '3-002'
        order by o.order_date desc
	</select>
	<!-- 완료된 주문 목록 -->
	<select id="getFinishOrderList" resultType="OrderVo">
		select o.*, u.user_name, d.dlvr_name 
        from tbl_order o
        inner join tbl_user u
        on o.user_no = u.user_no
        left outer join tbl_deliver d
        on o.dlvr_no = d.dlvr_no
        inner join tbl_code c
        on o.order_state = c.code_no
        where o.order_state = '3-003'
        order by o.order_date desc
	</select>
	
	<!-- 주문자 취소 목록 -->
	<select id="getCancelOrderList" resultType="OrderVo">
		select o.*, u.user_name from tbl_order o
		inner join tbl_user u
		on o.user_no = u.user_no     
		inner join tbl_code c
		on o.order_state = c.code_no
		where o.order_state = '3-004'
		order by o.order_date desc
	</select>
	
	<!-- 배달원 취소 목록 -->
	<select id="getCancelOrderListByDeliver" resultType="OrderVo">
		select o.*, u.user_name, d.dlvr_name 
        from tbl_order o
        inner join tbl_user u
        on o.user_no = u.user_no
        left outer join tbl_deliver d
        on o.dlvr_no = d.dlvr_no
        inner join tbl_code c
        on o.order_state = c.code_no
        where o.order_state = '3-005'
        order by o.order_date desc
	</select>
	
	<!-- 배달현황 수정 -->
	<update id="updateOrderState">
		update tbl_order set
		order_state = #{order_state}
		where order_no = #{order_no}
	</update>
	<!-- 주문(현황:대기중, 접수, 사용자취소, 배달원취소, 완료)목록 + 현황수정 끝 -->
	
	<!-- 게시물(일반, 리뷰, 공지) 목록  + 삭제 -->
	<!-- 일반글 목록 -->
	<select id="getPostList" resultType="TimelineVo">
		select t.*, d.dlvr_name, a.writer_name
		from tbl_timeline t 
		    left outer join tbl_deliver d
		    on t.dlvr_no = d.dlvr_no
		    left outer join (
		        select user_no account_no, user_name writer_name, user_img from tbl_user
		        union
		        select dlvr_no, dlvr_name, dlvr_img from tbl_deliver
		    ) a
		    on t.writer_no = a.account_no
            where time_state = '2-003'
            order by t.time_date desc
	</select>
	<!-- 리뷰 목록 -->
	<select id="getReviewList" resultType="TimelineVo">
		select t.*, d.dlvr_name, a.writer_name
		from tbl_timeline t 
		    left outer join tbl_deliver d
		    on t.dlvr_no = d.dlvr_no
		    left outer join (
		        select user_no account_no, user_name writer_name, user_img from tbl_user
		        union
		        select dlvr_no, dlvr_name, dlvr_img from tbl_deliver
		    ) a
		    on t.writer_no = a.account_no
            where time_state = '2-002'
            order by t.time_date desc	
	</select>
	<!-- 공지사항 목록 -->
	<select id="getNoticeList" resultType="TimelineVo">
		select t.*, d.dlvr_name, a.writer_name
			from tbl_timeline t 
			    left outer join tbl_deliver d
			    on t.dlvr_no = d.dlvr_no
			    left outer join (
			        select user_no account_no, user_name writer_name, user_img from tbl_user
			        union
			        select dlvr_no, dlvr_name, dlvr_img from tbl_deliver
			    ) a
			    on t.writer_no = a.account_no
	            where time_state = '2-001'
	            order by t.time_date desc	
	</select>
	<!-- 게시물 삭제 -->
	<delete id="deleteArticle">
		delete from tbl_timeline
		where time_no = #{time_no}
	</delete>
	<!-- 게시물(일반, 리뷰, 공지) 목록  + 삭제 끝 -->
	
	<!-- 신고 목록 + 처리 -->
	<select id="getReportList" resultType="ReportVo">
		select r.*, p.plt_name, d.def_name 
		from tbl_report r
		inner join (
		    select user_no plt_no, user_name plt_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) p
		on r.plt_no = p.plt_no
		inner join (
		    select user_no def_no, user_name def_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) d
		on r.def_no = d.def_no
		where report_state = '6-001'
	</select>
	
	<select id="getAcceptReportList" resultType="ReportVo">
		select r.*, p.plt_name, d.def_name 
		from tbl_report r
		inner join (
		    select user_no plt_no, user_name plt_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) p
		on r.plt_no = p.plt_no
		inner join (
		    select user_no def_no, user_name def_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) d
		on r.def_no = d.def_no
		where report_state = '6-002'
	</select>
	
	<select id="getCancelReportList" resultType="ReportVo">
		select r.*, p.plt_name, d.def_name 
		from tbl_report r
		inner join (
		    select user_no plt_no, user_name plt_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) p
		on r.plt_no = p.plt_no
		inner join (
		    select user_no def_no, user_name def_name from tbl_user
		    union
		    select dlvr_no, dlvr_name from tbl_deliver) d
		on r.def_no = d.def_no
		where report_state = '6-003'
	</select>
	
	<update id="updateReportState">
		update tbl_report set
		report_state = #{report_state}
		where report_no = #{report_no}
	</update>
</mapper>
